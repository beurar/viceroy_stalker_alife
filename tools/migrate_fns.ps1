$map = @{
    "avoidAnomalies" = "ai";
    "avoidAnomalyFields" = "ai";
    "resetAIBehavior" = "ai";
    "toggleFieldAvoid" = "ai";
    "triggerAIPanic" = "ai";
    "manageAmbushes" = "ambushes";
    "spawnAmbushes" = "ambushes";
    "startAmbushManager" = "ambushes";
    "cleanupAnomalyMarkers" = "anomalies";
    "cycleAnomalyFields" = "anomalies";
    "generateFieldName" = "anomalies";
    "manageAnomalyFields" = "anomalies";
    "setupAnomalyFields" = "anomalies";
    "spawnAllAnomalyFields" = "anomalies";
    "spawnBridgeAnomalyFields" = "anomalies";
    "startAnomalyManager" = "anomalies";
    "completeArtefactHunt" = "antistasi";
    "completeChemSample" = "antistasi";
    "disableWeather" = "antistasi";
    "isAntistasiUltimate" = "antistasi";
    "startArtefactHunt" = "antistasi";
    "startChemSample" = "antistasi";
    "startMutantHunt" = "antistasi";
    "defendTownFromZombies" = "antistasi";
    "startDefendTownFromZombies" = "antistasi";
    "manageAntistasiEvents" = "antistasi";
    "placeTownSirens" = "blowouts";
    "scheduleBlowouts" = "blowouts";
    "triggerBlowout" = "blowouts";
    "saveCache" = "cache";
    "loadCache" = "cache";
    "placeCachedMarkers" = "cache";
    "getSetting" = "cba";
    "cleanupChemicalZones" = "chemical";
    "expandValley" = "chemical";
    "findValleyPosition" = "chemical";
    "manageChemicalZones" = "chemical";
    "spawnChemicalZone" = "chemical";
    "spawnRandomChemicalZones" = "chemical";
    "spawnValleyChemicalFields" = "chemical";
    "spawnValleyChemicalZones" = "chemical";
    "createProximityAnchor" = "core";
    "evalSiteProximity" = "core";
    "findBeachesInMap" = "core";
    "findBridges" = "core";
    "findBuildingClusters" = "core";
    "findBuildingCoverSpot" = "core";
    "findCrossroads" = "core";
    "findHiddenPosition" = "core";
    "findLandPos" = "core";
    "findLandPosition" = "core";
    "findLandZones" = "core";
    "findRandomRoadPosition" = "core";
    "findRoadPosition" = "core";
    "findRoads" = "core";
    "findRockClusters" = "core";
    "findSniperSpots" = "core";
    "findSwamps" = "core";
    "findValleys" = "core";
    "getActiveCellsNearPlayers" = "core";
    "getLandSurfacePosition" = "core";
    "getRandomRoad" = "core";
    "getSurfacePosition" = "core";
    "hasPlayersNearby" = "core";
    "isWaterPosition" = "core";
    "radioMessage" = "core";
    "regenMapPoints" = "core";
    "registerEmissionHooks" = "core";
    "selectWeightedBuilding" = "core";
    "setupDebugActions" = "core";
    "spawnWorker" = "core";
    "togglePerfMetrics" = "core";
    "toggleSiteOverlay" = "core";
    "weightedPick" = "core";
    "initManagers" = "init";
    "initMap" = "init";
    "createGlobalMarker" = "markers";
    "createLocalMarker" = "markers";
    "markAllBuildings" = "markers";
    "markBeaches" = "markers";
    "markBridges" = "markers";
    "markBuildingClusters" = "markers";
    "markBuildingCoverSpot" = "markers";
    "markDeathLocation" = "markers";
    "markHiddenPosition" = "markers";
    "markLandZones" = "markers";
    "markPlayerRanges" = "markers";
    "markRoads" = "markers";
    "markRockClusters" = "markers";
    "markSitesOverlay" = "markers";
    "markSniperSpots" = "markers";
    "markSwamps" = "markers";
    "markValleys" = "markers";
    "manageBoobyTraps" = "minefields";
    "manageIEDSites" = "minefields";
    "manageMinefields" = "minefields";
    "registerMinefield" = "minefields";
    "spawnAPERSField" = "minefields";
    "spawnBoobyTraps" = "minefields";
    "spawnIED" = "minefields";
    "spawnIEDSites" = "minefields";
    "spawnMinefieldQueued" = "minefields";
    "spawnMinefields" = "minefields";
    "spawnTripwirePerimeter" = "minefields";
    "startIEDManager" = "minefields";
    "startMinefieldManager" = "minefields";
    "initMutantUnit" = "mutants";
    "isMutantEnabled" = "mutants";
    "manageHabitats" = "mutants";
    "manageHerds" = "mutants";
    "manageHostiles" = "mutants";
    "manageNests" = "mutants";
    "managePredators" = "mutants";
    "onMutantKilled" = "mutants";
    "setupMutantHabitats" = "mutants";
    "spawnAcidSmasherNest" = "mutants";
    "spawnAmbientHerds" = "mutants";
    "spawnBehemothNest" = "mutants";
    "spawnBlindDogNest" = "mutants";
    "spawnBloodsuckerNest" = "mutants";
    "spawnBoarNest" = "mutants";
    "spawnCachedHabitats" = "mutants";
    "spawnCatNest" = "mutants";
    "spawnControllerNest" = "mutants";
    "spawnCorruptorNest" = "mutants";
    "spawnFleshNest" = "mutants";
    "spawnHabitatHunters" = "mutants";
    "spawnIzlomNest" = "mutants";
    "spawnMutantGroup" = "mutants";
    "spawnMutantNest" = "mutants";
    "spawnPredatorAttack" = "mutants";
    "spawnPseudodogNest" = "mutants";
    "spawnPseudogiantNest" = "mutants";
    "spawnSmasherNest" = "mutants";
    "spawnSnorkNest" = "mutants";
    "updateProximity" = "mutants";
    "scheduleNecroplague" = "necroplague";
    "triggerNecroplague" = "necroplague";
    "manageSpookZones" = "spooks";
    "setupSpookZones" = "spooks";
    "spawnSpookZone" = "spooks";
    "findCampBuilding" = "stalkers";
    "findDynamicSniperSpots" = "stalkers";
    "debugSpawnSnipers" = "stalkers";
    "getStalkerFactions" = "stalkers";
    "manageSnipers" = "stalkers";
    "sniperAssaultLogic" = "stalkers";
    "manageStalkerCamps" = "stalkers";
    "manageWanderers" = "stalkers";
    "spawnAmbientStalkers" = "stalkers";
    "spawnFlareTripwires" = "stalkers";
    "spawnSmartFlarePerimeter" = "stalkers";
    "spawnSniper" = "stalkers";
    "sniperScan" = "stalkers";
    "spawnStalkerCamp" = "stalkers";
    "spawnStalkerCamps" = "stalkers";
    "startCampManager" = "stalkers";
    "startSniperManager" = "stalkers";
    "applyServerState" = "server";
    "callServer" = "server";
    "callServerHelper" = "server";
    "getServerMetrics" = "server";
    "requestServerState" = "server";
    "remoteReturn" = "server";
    "sendServerState" = "server";
    "scanMap" = "smart_terrains";
    "findVantagePoints" = "smart_terrains";
    "schedulePsyStorms" = "storms";
    "triggerPsyStorm" = "storms";
    "findWrecks" = "wrecks";
    "manageWrecks" = "wrecks";
    "markWrecks" = "wrecks";
    "spawnAbandonedVehicles" = "wrecks";
    "spawnZombiesFromQueue" = "zombification";
    "trackDeadForZombify" = "zombification"
}

$rootPath = "c:\Source\viceroy_stalker_alife\addons\main"
$files = Get-ChildItem -Path $rootPath -Recurse -Filter *.sqf

$utf8NoBom = New-Object System.Text.UTF8Encoding $false

foreach ($file in $files) {
    if ($file.FullName -like "*migrate_fns.ps1*" -or $file.FullName -like "*cba_settings.sqf*") {
        continue
    }

    $content = [System.IO.File]::ReadAllText($file.FullName)
    $originalContent = $content
    
    $matches = [regex]::Matches($content, "VIC_fnc_(\w+)")
    
    foreach ($match in $matches) {
        $fncName = $match.Groups[1].Value
        # Write-Host "Found $fncName in $($file.Name)"
        
        if ($map.ContainsKey($fncName)) {
            $folder = $map[$fncName]
            $replacement = "viceroy_stalker_alife_${folder}_fnc_${fncName}"
            $content = $content.Replace("VIC_fnc_$fncName", $replacement)
        } else {
             # Write-Host "Skipping unknown or ambiguous function: $fncName in $($file.Name)"
        }
    }
    
    if ($content -ne $originalContent) {
        [System.IO.File]::WriteAllText($file.FullName, $content, $utf8NoBom)
        Write-Host "Updated $($file.Name)"
    }
}
